# NGINX Reverse Proxy Configuration
# Acts as the single public entry point for the API gateway
# Frontend never calls external APIs directly - everything goes through NGINX

server {
    listen 80;
    server_name _;

    # Root health check
    location / {
        return 200 "API Gateway - Reverse Proxy Active";
        add_header Content-Type text/plain;
    }

    # Main gateway endpoint - aggregates external API data
    # This is the only endpoint the frontend should call
    # POST /api/state -> routes to gateway service
    location /api/state {
        # Rewrite /api/state to /state for the backend service
        rewrite ^/api(.*)$ $1 break;
        
        # Proxy to gateway service (port 8000)
        proxy_pass http://gateway:8000;
        
        # Forward client information to backend
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Increase timeout for external API calls
        proxy_read_timeout 30s;
        proxy_connect_timeout 10s;
    }

    # Health check endpoint for monitoring
    location /api/health {
        rewrite ^/api(.*)$ $1 break;
        proxy_pass http://gateway:8000;
        proxy_set_header Host $host;
    }

    # Metrics endpoint - NEW
    location /metrics {
        proxy_pass http://gateway:8000/metrics;
        proxy_set_header Host $host;
    }

    # External health check - NEW
    location /health/external {
        proxy_pass http://gateway:8000/health/external;
        proxy_set_header Host $host;
    }
}
